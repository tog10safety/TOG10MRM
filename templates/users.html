<!-- templates/users.html -->

{% extends "base.html" %} {% block title %}User Management - Mission Risk
Management{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="h3 mb-0">
          <i class="fas fa-users-cog me-2"></i>User Management
        </h1>
        <p class="text-muted mb-0">Manage system users and permissions</p>
      </div>
      <div class="col-auto">
        <div class="btn-group">
          <a href="{{ url_for('reports') }}" class="btn btn-info">
            <i class="fas fa-chart-bar me-2"></i>Reports
          </a>
          <a href="{{ url_for('add_user') }}" class="btn btn-primary">
            <i class="fas fa-user-plus me-2"></i>Add New User
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card bg-primary text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Total Users
              </div>
              <div class="h5 mb-0">{{ users|length }}</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-users fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-success text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Active Users
              </div>
              <div class="h5 mb-0">
                {{ users|selectattr('is_active')|list|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-user-check fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-warning text-dark mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Administrators
              </div>
              <div class="h5 mb-0">
                {{ users|selectattr('authority', 'equalto',
                'Administrator')|list|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-user-shield fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-info text-white mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Without Designation
              </div>
              <div class="h5 mb-0">
                {{ users|rejectattr('designation')|list|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-tag fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Users</h6>
    </div>
    <div class="card-body py-2">
      <div class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label small fw-bold">Search:</label>
          <input
            type="text"
            class="form-control form-control-sm"
            id="searchInput"
            placeholder="Search users..."
          />
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold">Authority:</label>
          <select class="form-select form-select-sm" id="authorityFilter">
            <option value="">All Authorities</option>
            <option value="Administrator">Administrator</option>
            <option value="Evaluator">Evaluator</option>
            <option value="Creator">Creator</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold">Designation:</label>
          <select class="form-select form-select-sm" id="designationFilter">
            <option value="">All Designations</option>
            <option value="Commander">Commander</option>
            <option value="Director for Operations">
              Director for Operations
            </option>
            <option value="Squadron Commander">Squadron Commander</option>
            <option value="Supervisor/OIC">Supervisor/OIC</option>
            <option value="Operator">Operator</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold">Unit:</label>
          <select class="form-select form-select-sm" id="unitFilter">
            <option value="">All Units</option>
            {% set units = [] %} {% for user in users %} {% if user.unit and
            user.unit not in units %} {% set _ = units.append(user.unit) %}
            <option value="{{ user.unit }}">{{ user.unit }}</option>
            {% endif %} {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold">Status:</label>
          <select class="form-select form-select-sm" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold">&nbsp;</label>
          <div class="d-flex gap-1">
            <button
              class="btn btn-sm btn-outline-secondary w-100"
              id="resetFilters"
            >
              <i class="fas fa-times me-1"></i>Reset
            </button>
            <button
              class="btn btn-sm btn-outline-primary w-100"
              id="applyFilters"
            >
              <i class="fas fa-filter me-1"></i>Apply
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Users</h5>
      <div class="text-muted small">
        Showing <span id="visibleCount">{{ users|length }}</span> of {{
        users|length }} user(s)
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-sm" id="usersTable">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Full Name</th>
              <th>Authority</th>
              <th>Designation</th>
              <th>Category</th>
              <th>Unit</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr
              data-authority="{{ user.authority }}"
              data-designation="{{ user.designation or '' }}"
              data-unit="{{ user.unit }}"
              data-status="{{ 'active' if user.is_active else 'inactive' }}"
            >
              <td><strong>#{{ user.id }}</strong></td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-user-circle text-muted me-2"></i>
                  {{ user.username }}
                </div>
              </td>
              <td>{{ user.get_full_name() }}</td>
              <td>
                <span
                  class="badge {% if user.authority == 'Administrator' %}bg-danger {% elif user.authority == 'Evaluator' %}bg-warning text-dark {% else %}bg-info{% endif %}"
                >
                  {{ user.authority }}
                </span>
              </td>
              <td>
                {% if user.designation %}
                <span class="badge bg-secondary">{{ user.designation }}</span>
                {% else %}
                <span class="badge bg-light text-dark">Not Set</span>
                {% endif %}
              </td>
              <td>
                <small>{{ user.category }}</small>
              </td>
              <td>
                <span class="badge bg-light text-dark unit-badge"
                  >{{ user.unit }}</span
                >
              </td>
              <td>
                <span
                  class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}"
                >
                  <i
                    class="fas {% if user.is_active %}fa-check-circle{% else %}fa-times-circle{% endif %} me-1"
                  ></i>
                  {{ 'Active' if user.is_active else 'Inactive' }}
                </span>
              </td>
              <td>
                <small class="text-muted">
                  {{ user.date_created.strftime('%Y-%m-%d') if user.date_created
                  else 'N/A' }}
                </small>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a
                    href="{{ url_for('edit_user', user_id=user.id) }}"
                    class="btn btn-outline-primary"
                    title="Edit User"
                  >
                    <i class="fas fa-edit"></i>
                  </a>
                  <form
                    method="POST"
                    action="{{ url_for('toggle_user', user_id=user.id) }}"
                    style="display: inline"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <button
                      type="submit"
                      class="btn btn-outline-{% if user.is_active %}warning{% else %}success{% endif %}"
                      title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %} User"
                    >
                      <i
                        class="fas {% if user.is_active %}fa-pause{% else %}fa-play{% endif %}"
                      ></i>
                    </button>
                  </form>
                  {% if user.id != session['user_id'] %}
                  <form
                    method="POST"
                    action="{{ url_for('delete_user', user_id=user.id) }}"
                    style="display: inline"
                    onsubmit="return confirmDelete('{{ user.username }}')"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <button
                      type="submit"
                      class="btn btn-outline-danger"
                      title="Delete User"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                  {% else %}
                  <button
                    class="btn btn-outline-secondary"
                    disabled
                    title="Cannot delete your own account"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="10" class="text-center py-4">
                <i class="fas fa-users fa-2x text-muted mb-3"></i>
                <p class="text-muted">No users found.</p>
                <a href="{{ url_for('add_user') }}" class="btn btn-primary"
                  ><i class="fas fa-user-plus me-2"></i>Add First User</a
                >
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Summary -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <p class="text-muted mb-0">
          Showing <strong id="summaryCount">{{ users|length }}</strong> user(s)
        </p>
        <div>
          <span class="badge bg-primary me-2"
            >Admin: {{ users|selectattr('authority', 'equalto',
            'Administrator')|list|length }}</span
          >
          <span class="badge bg-warning text-dark me-2"
            >Evaluator: {{ users|selectattr('authority', 'equalto',
            'Evaluator')|list|length }}</span
          >
          <span class="badge bg-info"
            >Creator: {{ users|selectattr('authority', 'equalto',
            'Creator')|list|length }}</span
          >
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Filter functionality
  function applyFilters() {
    const searchTerm = document
      .getElementById("searchInput")
      .value.toLowerCase();
    const authorityFilter = document.getElementById("authorityFilter").value;
    const designationFilter =
      document.getElementById("designationFilter").value;
    const unitFilter = document.getElementById("unitFilter").value;
    const statusFilter = document.getElementById("statusFilter").value;

    const rows = document.querySelectorAll("#usersTable tbody tr");
    let visibleCount = 0;

    rows.forEach((row) => {
      if (row.cells.length <= 1) return; // Skip empty rows

      const username = row.cells[1].textContent.toLowerCase();
      const fullName = row.cells[2].textContent.toLowerCase();
      const authority = row.getAttribute("data-authority");
      const designation = row.getAttribute("data-designation");
      const unit = row.getAttribute("data-unit");
      const status = row.getAttribute("data-status");

      // Check search term
      const matchesSearch =
        searchTerm === "" ||
        username.includes(searchTerm) ||
        fullName.includes(searchTerm);

      // Check authority filter
      const matchesAuthority =
        authorityFilter === "" || authority === authorityFilter;

      // Check designation filter
      const matchesDesignation =
        designationFilter === "" || designation === designationFilter;

      // Check unit filter
      const matchesUnit = unitFilter === "" || unit === unitFilter;

      // Check status filter
      const matchesStatus =
        statusFilter === "" ||
        (statusFilter === "active" && status === "active") ||
        (statusFilter === "inactive" && status === "inactive");

      // Show/hide row based on all filters
      const shouldShow =
        matchesSearch &&
        matchesAuthority &&
        matchesDesignation &&
        matchesUnit &&
        matchesStatus;
      row.style.display = shouldShow ? "" : "none";

      if (shouldShow) {
        visibleCount++;
      }
    });

    // Update counters
    document.getElementById("visibleCount").textContent = visibleCount;
    document.getElementById("summaryCount").textContent = visibleCount;

    // Show message if no results
    const noResultsRow = document.querySelector(
      "#usersTable tbody tr:first-child"
    );
    if (visibleCount === 0 && noResultsRow && noResultsRow.cells.length > 1) {
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="text-center py-4">
            <i class="fas fa-search fa-2x text-muted mb-3"></i>
            <p class="text-muted">No users match your filters.</p>
            <button class="btn btn-primary" onclick="resetFilters()">
              <i class="fas fa-times me-2"></i>Clear Filters
            </button>
          </td>
        </tr>
      `;
    }
  }

  // Reset all filters
  function resetFilters() {
    document.getElementById("searchInput").value = "";
    document.getElementById("authorityFilter").value = "";
    document.getElementById("designationFilter").value = "";
    document.getElementById("unitFilter").value = "";
    document.getElementById("statusFilter").value = "";
    applyFilters();
  }

  // Event listeners
  document.addEventListener("DOMContentLoaded", function () {
    // Search input
    document
      .getElementById("searchInput")
      .addEventListener("input", applyFilters);

    // Filter dropdowns
    document
      .getElementById("authorityFilter")
      .addEventListener("change", applyFilters);
    document
      .getElementById("designationFilter")
      .addEventListener("change", applyFilters);
    document
      .getElementById("unitFilter")
      .addEventListener("change", applyFilters);
    document
      .getElementById("statusFilter")
      .addEventListener("change", applyFilters);

    // Buttons
    document
      .getElementById("resetFilters")
      .addEventListener("click", resetFilters);
    document
      .getElementById("applyFilters")
      .addEventListener("click", applyFilters);

    // Initialize filters
    applyFilters();
  });

  // Enhanced delete confirmation
  function confirmDelete(username) {
    return confirm(
      `Are you sure you want to permanently delete user "${username}"?\n\nThis action cannot be undone and will remove all associated data.`
    );
  }

  // Keyboard shortcuts
  document.addEventListener("keydown", function (e) {
    // Ctrl/Cmd + F to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === "f") {
      e.preventDefault();
      document.getElementById("searchInput").focus();
    }

    // Escape to reset filters
    if (e.key === "Escape") {
      resetFilters();
    }
  });
</script>
{% endblock %} {% block extra_css %}
<style>
  .table-sm td,
  .table-sm th {
    padding: 0.5rem;
    font-size: 0.875rem;
  }

  .btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
  }

  .badge {
    font-size: 0.75em;
  }

  .unit-badge {
    font-family: monospace;
    font-size: 0.7em;
  }

  /* Hover effects */
  .table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.025);
  }

  /* Filter section styling */
  .card-header.bg-light {
    background-color: #f8f9fa !important;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .btn-group {
      flex-direction: column;
    }

    .btn-group .btn {
      margin-bottom: 0.25rem;
    }

    .card-header {
      flex-direction: column;
      gap: 1rem;
    }

    .table-responsive {
      font-size: 0.8rem;
    }

    /* Stack filters on mobile */
    .row.g-2 > .col-md-2 {
      margin-bottom: 0.5rem;
    }
  }

  @media (max-width: 576px) {
    .filters-section .row {
      flex-direction: column;
    }

    .filters-section .col-md-2 {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }
</style>
{% endblock %}

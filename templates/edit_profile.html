<!-- templates/edit_profile.html -->

{% extends "base.html" %} {% block title %}Edit Profile - Mission Risk
Management{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="h3 mb-0">
          <i class="fas fa-user-edit me-2"></i>Edit My Profile
        </h1>
        <p class="text-muted mb-0">
          Update your password and view your information
        </p>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
  </div>

  <!-- Edit Profile Form -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-user-circle me-2"></i>Profile Information
      </h5>
    </div>
    <div class="card-body">
      <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <!-- Personal Information (Read-only) -->
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="fas fa-id-card me-2"></i>Personal Information
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label fw-semibold">Rank/Position</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  value="{{ user.rank or 'Not specified' }}"
                  readonly
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label fw-semibold">First Name</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  value="{{ user.first_name }}"
                  readonly
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label fw-semibold">Middle Name</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  value="{{ user.middle_name or 'Not specified' }}"
                  readonly
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label fw-semibold">Last Name</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  value="{{ user.last_name }}"
                  readonly
                />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Unit</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  value="{{ user.unit }}"
                  readonly
                />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Designation</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  value="{{ user.designation or 'Not specified' }}"
                  readonly
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Password Change Section -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="fas fa-key me-2"></i>Change Password</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="old_password" class="form-label fw-semibold"
                  >Current Password *</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="old_password"
                  name="old_password"
                  placeholder="Enter your current password"
                  required
                />
                <div class="form-text">
                  You must verify your current password to make changes
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <label for="new_password" class="form-label fw-semibold"
                  >New Password *</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="new_password"
                  name="new_password"
                  placeholder="Enter new password"
                  required
                />
                <div class="form-text">
                  Must be 8+ characters with uppercase, lowercase, number, and
                  special character
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <label for="confirm_password" class="form-label fw-semibold"
                  >Confirm New Password *</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirm_password"
                  name="confirm_password"
                  placeholder="Confirm new password"
                  required
                />
                <div class="form-text">
                  Re-enter your new password to confirm
                </div>
              </div>
            </div>

            <!-- Password Strength Indicator -->
            <div class="row">
              <div class="col-12">
                <div class="password-strength mt-2">
                  <div class="progress mb-2" style="height: 5px">
                    <div
                      class="progress-bar"
                      id="passwordStrengthBar"
                      style="width: 0%"
                    ></div>
                  </div>
                  <small class="text-muted" id="passwordStrengthText"
                    >Password strength</small
                  >
                </div>
              </div>
            </div>

            <!-- Password Requirements -->
            <div class="alert alert-info mt-3">
              <h6 class="alert-heading mb-2">
                <i class="fas fa-info-circle me-2"></i>Password Requirements:
              </h6>
              <ul class="mb-0 small">
                <li>Minimum 8 characters long</li>
                <li>At least one uppercase letter (A-Z)</li>
                <li>At least one lowercase letter (a-z)</li>
                <li>At least one number (0-9)</li>
                <li>At least one special character (!@#$%^&* etc.)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 justify-content-end">
          <button type="submit" class="btn btn-success" id="submitBtn">
            <i class="fas fa-save me-2"></i>Update Password
          </button>
          <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const newPasswordInput = document.getElementById("new_password");
    const confirmPasswordInput = document.getElementById("confirm_password");
    const strengthBar = document.getElementById("passwordStrengthBar");
    const strengthText = document.getElementById("passwordStrengthText");
    const submitBtn = document.getElementById("submitBtn");

    // Password strength checker
    newPasswordInput.addEventListener("input", function () {
      const password = this.value;
      let strength = 0;

      // Length check
      if (password.length >= 8) strength += 25;

      // Character type checks
      if (/[A-Z]/.test(password)) strength += 25;
      if (/[a-z]/.test(password)) strength += 25;
      if (/[0-9]/.test(password)) strength += 15;
      if (/[^A-Za-z0-9]/.test(password)) strength += 10;

      // Update progress bar
      strengthBar.style.width = strength + "%";

      // Update colors and text
      if (strength < 50) {
        strengthBar.className = "progress-bar bg-danger";
        strengthText.textContent = "Weak password";
        strengthText.className = "text-danger";
      } else if (strength < 80) {
        strengthBar.className = "progress-bar bg-warning";
        strengthText.textContent = "Medium strength";
        strengthText.className = "text-warning";
      } else {
        strengthBar.className = "progress-bar bg-success";
        strengthText.textContent = "Strong password";
        strengthText.className = "text-success";
      }
    });

    // Password confirmation check
    confirmPasswordInput.addEventListener("input", function () {
      const newPassword = newPasswordInput.value;
      const confirmPassword = this.value;

      if (confirmPassword && newPassword !== confirmPassword) {
        this.classList.add("is-invalid");
        this.classList.remove("is-valid");
      } else if (confirmPassword && newPassword === confirmPassword) {
        this.classList.add("is-valid");
        this.classList.remove("is-invalid");
      } else {
        this.classList.remove("is-valid", "is-invalid");
      }
    });

    // Form validation
    document.querySelector("form").addEventListener("submit", function (e) {
      const oldPassword = document.getElementById("old_password").value;
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Check if old password is provided
      if (!oldPassword) {
        e.preventDefault();
        alert("Please enter your current password");
        return;
      }

      // Check if new passwords match
      if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert("New passwords do not match. Please confirm your new password.");
        return;
      }

      // Check password strength
      const hasUpperCase = /[A-Z]/.test(newPassword);
      const hasLowerCase = /[a-z]/.test(newPassword);
      const hasNumbers = /[0-9]/.test(newPassword);
      const hasSpecialChar = /[^A-Za-z0-9]/.test(newPassword);

      if (
        newPassword.length < 8 ||
        !hasUpperCase ||
        !hasLowerCase ||
        !hasNumbers ||
        !hasSpecialChar
      ) {
        e.preventDefault();
        alert(
          "New password does not meet the security requirements. Please check the password requirements."
        );
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    });
  });

  // Toggle password visibility (optional enhancement)
  function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const type = field.type === "password" ? "text" : "password";
    field.type = type;
  }
</script>
{% endblock %} {% block extra_css %}
<style>
  .bg-light {
    background-color: #f8f9fa !important;
  }

  .form-control:read-only {
    background-color: #f8f9fa;
    border-color: #e9ecef;
  }

  .progress {
    background-color: #e9ecef;
  }

  .alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
  }

  .card-header.bg-light {
    background-color: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6;
  }

  .form-text {
    font-size: 0.75rem;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .card-body .row > div {
      margin-bottom: 1rem;
    }

    .d-flex.justify-content-end {
      justify-content: center !important;
    }

    .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }
</style>
{% endblock %}

<!-- templates/hazard.html -->

{% extends "base.html" %} 
{% block title %}Hazard Registry - MRM System{% endblock %} 

{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1">
        <i class="fas fa-exclamation-triangle me-2 text-primary"></i>Hazard Registry
      </h1>
      <p class="text-muted mb-0 small">Manage all identified hazards in the system</p>
    </div>
    <div class="col-auto">
      {% if current_user.authority in ['Administrator', 'Evaluator'] %}
      <a href="{{ url_for('add_hazard') }}" class="btn btn-primary btn-sm">
        <i class="fas fa-plus me-1"></i>Add New Hazard
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="card mb-3">
    <div class="card-body p-3">
      <form method="GET" class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label small fw-semibold mb-1">Search Hazard Description</label>
          <input 
            type="text" 
            name="search" 
            class="form-control form-control-sm" 
            placeholder="Search hazard descriptions..."
            value="{{ search_query }}"
          >
        </div>
        <div class="col-md-4">
          <label class="form-label small fw-semibold mb-1">Filter by Activity Code</label>
          <select class="form-select form-select-sm" name="activity_code">
            <option value="">All Activity Codes</option>
            {% for code in activity_codes %}
            <option value="{{ code }}" {% if activity_filter == code %}selected{% endif %}>{{ code }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-sm w-100">
            <i class="fas fa-filter me-1"></i>Apply
          </button>
        </div>
        <div class="col-md-1">
          <a href="{{ url_for('view_hazards') }}" class="btn btn-outline-secondary btn-sm w-100" title="Reset Filters">
            <i class="fas fa-refresh"></i>
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Hazards Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
      <h6 class="mb-0">
        <i class="fas fa-list me-1 text-primary"></i>All Hazards
      </h6>
      <span class="text-primary small">{{ hazards|length }} hazard(s)</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-modern table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th width="6%">ID</th>
              <th width="12%">Activity Code</th>
              <th width="12%">Unit</th>
              <th width="25%">Hazard Description</th>
              <th width="12%">Before Mitigation</th>
              <th width="18%">Mitigation Strategies</th>
              <th width="10%">After Mitigation</th>
              <th width="8%">Updated</th>
              {% if current_user.authority in ['Administrator', 'Evaluator'] %}
              <th width="8%">Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for hazard in hazards %}
            <tr>
              <td>
                <strong class="small text-primary">#{{ hazard.id }}</strong>
              </td>
              <td>
                <span class="badge bg-info bg-opacity-20">{{ hazard.activity_code }}</span>
              </td>
              <td class="small">{{ hazard.unit }}</td>
              <td>
                <div class="small">{{ hazard.hazard_description }}</div>
              </td>
              <td>
                <div class="small">
                  <div><strong>L:</strong> {{ hazard.get_likelihood_description(hazard.before_likelihood) }}</div>
                  <div><strong>S:</strong> {{ hazard.get_severity_description(hazard.before_severity) }}</div>
                  <div>
                    <strong>Risk:</strong>
                    <span class="badge bg-{{ hazard.get_risk_color(hazard.before_risk_rating) }} badge-sm">
                      {{ hazard.before_risk_rating }}
                    </span>
                  </div>
                </div>
              </td>
              <td>
                <div class="mitigation-content small">
                  {% set mitigation_lines = hazard.mitigations.split('\n') %}
                  {% if mitigation_lines %}
                  <ul class="list-unstyled mb-0">
                    {% for line in mitigation_lines %}
                    {% if line.strip() %}
                    <li class="mb-1">
                      <i class="fas fa-chevron-right text-primary me-1 small"></i>
                      {{ line.strip() }}
                    </li>
                    {% endif %}
                    {% endfor %}
                  </ul>
                  {% endif %}
                </div>
              </td>
              <td>
                <div class="small">
                  <div><strong>L:</strong> {{ hazard.get_likelihood_description(hazard.after_likelihood) }}</div>
                  <div><strong>S:</strong> {{ hazard.get_severity_description(hazard.after_severity) }}</div>
                  <div>
                    <strong>Risk:</strong>
                    <span class="badge bg-{{ hazard.get_risk_color(hazard.after_risk_rating) }} badge-sm">
                      {{ hazard.after_risk_rating }}
                    </span>
                  </div>
                </div>
              </td>
              <td class="small text-muted">
                {{ hazard.date_updated.strftime('%m/%d/%y') }}
              </td>
              {% if current_user.authority in ['Administrator', 'Evaluator'] %}
              <td>
                <div class="btn-group-vertical btn-group-sm">
                  <a
                    href="{{ url_for('edit_hazard', hazard_id=hazard.id) }}"
                    class="btn btn-outline-primary mb-1"
                    title="Edit Hazard"
                  >
                    <i class="fas fa-edit"></i>
                  </a>
                  <form
                    method="POST"
                    action="{{ url_for('delete_hazard', hazard_id=hazard.id) }}"
                    class="d-inline"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <button
                      type="submit"
                      class="btn btn-outline-danger w-100"
                      onclick="return confirm('Delete hazard #{{ hazard.id }}?')"
                      title="Delete Hazard"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% else %}
            <tr>
              <td colspan="{% if current_user.authority in ['Administrator', 'Evaluator'] %}9{% else %}8{% endif %}" class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-muted mb-2 opacity-50"></i>
                <p class="text-muted small mb-2">No hazards found in the registry.</p>
                {% if current_user.authority in ['Administrator', 'Evaluator'] %}
                <a href="{{ url_for('add_hazard') }}" class="btn btn-primary btn-sm">
                  Add First Hazard
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Results Count -->
    {% if hazards %}
    <div class="card-footer py-2">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">Showing {{ hazards|length }} hazard(s)</small>
        {% if hazards|length > 10 %}
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">Next</a></li>
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  <br><br>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .mitigation-content {
    max-height: 100px;
    overflow-y: auto;
    padding-right: 5px;
    font-size: 0.8rem;
  }
  
  .mitigation-content ul li {
    padding: 1px 0;
    border-bottom: 1px solid #f0f0f0;
    line-height: 1.3;
  }
  
  .mitigation-content ul li:last-child {
    border-bottom: none;
  }
  
  .btn-group-vertical .btn {
    margin-bottom: 0.2rem;
    border-radius: 6px;
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
  }
  
  @media (max-width: 768px) {
    .btn-group-vertical {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.2rem;
    }
    
    .btn-group-vertical .btn {
      margin-bottom: 0;
      flex: 1;
      min-width: 35px;
    }
    
    .table-responsive {
      font-size: 0.8rem;
    }
    
    .mitigation-content {
      max-height: 80px;
    }
  }
</style>
{% endblock %}